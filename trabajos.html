<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Archivos</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="trabajos">

<div class="contenido" id="contenedor-archivos">
    <h1 id="titulo"></h1>

    <div id="adminUpload" style="display:none;">
        <input type="file" id="fileInput">
        <select id="categorySelect"></select>
        <button onclick="subirArchivo()">Subir Archivo</button>
    </div>

    <ul id="lista"></ul>

    <a href="categorias.html" class="volver">Volver</a>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script src="auth.js"></script>
<script src="roles.js"></script>

<script>
const params = new URLSearchParams(window.location.search);
const tipo = params.get("tipo");

const titulo = document.getElementById("titulo");
const lista = document.getElementById("lista");

async function cargarArchivos() {
    // Cargar categorías
    const catSnap = await db.collection("categories").where("name", "==", tipo).get();
    if(catSnap.empty) return;
    const catId = catSnap.docs[0].id;
    titulo.textContent = tipo;

    // Cargar archivos
    const filesSnap = await db.collection("files").where("category", "==", catId).get();
    lista.innerHTML = "";

    filesSnap.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.innerHTML = `<a href="${data.url}" target="_blank">${data.name}</a>`;
        lista.appendChild(li);
    });

    // Admin: cargar select para subir archivos
    if(localStorage.getItem("rol") === "admin") {
        document.getElementById("adminUpload").style.display = "block";

        const select = document.getElementById("categorySelect");
        const catSnapshot = await db.collection("categories").get();
        select.innerHTML = "";
        catSnapshot.forEach(c => {
            const option = document.createElement("option");
            option.value = c.id;
            option.textContent = c.data().name;
            select.appendChild(option);
        });
    }
}

async function subirArchivo() {
    const fileInput = document.getElementById("fileInput");
    const categorySelect = document.getElementById("categorySelect");

    const file = fileInput.files[0];
    const categoryId = categorySelect.value;

    if(!file || !categoryId) return alert("Selecciona archivo y categoría");

    const storageRef = firebase.storage().ref(`archivos/${file.name}`);
    const snapshot = await storageRef.put(file);
    const url = await snapshot.ref.getDownloadURL();

    await db.collection("files").add({
        name: file.name,
        url: url,
        category: categoryId
    });

    fileInput.value = "";
    cargarArchivos();
}

cargarArchivos();
</script>
</body>
</html>
